import { Component, createSignal, Show } from "solid-js";
import { BsDownload } from "solid-icons/bs";
import { chaptersStore } from "../stores/chaptersStore";
import { messagesStore } from "../stores/messagesStore";
import { generateMessageId } from "../utils/id";
import { IconButton } from "./IconButton";
import styles from "./ImportChapterButton.module.css";

interface ImportChapterButtonProps {
    afterMessageId?: string | (() => string | undefined) | null;
}

export const ImportChapterButton: Component<ImportChapterButtonProps> = (props) => {
    const [showModal, setShowModal] = createSignal(false);
    const [importText, setImportText] = createSignal("");
    const [isImporting, setIsImporting] = createSignal(false);
    const [error, setError] = createSignal("");

    const handleImport = async () => {
        const text = importText().trim();
        if (!text) return;

        setIsImporting(true);
        setError("");

        try {
            // Parse the JSON
            const importData = JSON.parse(text);
            
            // Validate the structure
            if (!importData.chapter || !importData.messages) {
                throw new Error("Invalid chapter format. Expected 'chapter' and 'messages' fields.");
            }

            const { chapter, messages } = importData;
            
            // Get the afterMessageId
            let afterMessageId = typeof props.afterMessageId === "function"
                ? props.afterMessageId()
                : props.afterMessageId;
            
            // Ensure it's string | null (not undefined)
            if (afterMessageId === undefined) {
                afterMessageId = null;
            }

            // Create the new chapter
            const newChapterId = generateMessageId();
            const newChapter = {
                ...chapter,
                id: newChapterId,
                createdAt: new Date(),
                updatedAt: new Date(),
            };

            // Add the chapter
            await chaptersStore.addChapterWithData(newChapter, afterMessageId);

            // Create the chapter marker message
            const markerMessage = {
                id: generateMessageId(),
                role: "assistant" as const,
                content: chapter.title || "Untitled Chapter",
                type: "chapter" as const,
                chapterId: newChapterId,
                timestamp: new Date(),
                isQuery: false,
                summary: chapter.summary,
            };

            // Insert the marker
            messagesStore.insertMessage(afterMessageId as string | null, markerMessage);

            // Insert all the messages from the imported chapter
            let lastMessageId = markerMessage.id;
            for (const msg of messages) {
                // Skip the original chapter marker
                if (msg.type === "chapter") continue;
                
                const newMessage = {
                    ...msg,
                    id: generateMessageId(),
                    chapterId: newChapterId,
                    timestamp: new Date(msg.timestamp),
                };
                
                messagesStore.insertMessage(lastMessageId, newMessage);
                lastMessageId = newMessage.id;
            }

            // Clear and close
            setImportText("");
            setShowModal(false);
            
            // Trigger save
            messagesStore.saveManually();
            
        } catch (error) {
            console.error("Failed to import chapter:", error);
            setError(error instanceof Error ? error.message : "Failed to import chapter");
        } finally {
            setIsImporting(false);
        }
    };

    return (
        <>
            <IconButton
                onClick={() => setShowModal(true)}
                title="Import chapter from JSON"
            >
                <BsDownload size={18} />
            </IconButton>

            <Show when={showModal()}>
                <div class={styles.modalOverlay} onClick={() => setShowModal(false)}>
                    <div class={styles.modal} onClick={(e) => e.stopPropagation()}>
                        <div class={styles.modalHeader}>
                            <h3>Import Chapter</h3>
                            <button
                                class={styles.closeButton}
                                onClick={() => setShowModal(false)}
                            >
                                Ã—
                            </button>
                        </div>
                        
                        <div class={styles.modalContent}>
                            <p class={styles.info}>
                                Paste the JSON export of a chapter below. The chapter will be inserted at this location.
                            </p>
                            
                            <textarea
                                class={styles.textarea}
                                placeholder="Paste chapter JSON here..."
                                value={importText()}
                                onInput={(e) => setImportText(e.currentTarget.value)}
                                rows={15}
                            />
                            
                            <Show when={error()}>
                                <div class={styles.error}>
                                    {error()}
                                </div>
                            </Show>
                        </div>
                        
                        <div class={styles.modalFooter}>
                            <button
                                class={styles.modalImportButton}
                                onClick={handleImport}
                                disabled={!importText().trim() || isImporting()}
                            >
                                {isImporting() ? "Importing..." : "Import Chapter"}
                            </button>
                            <button
                                class={styles.cancelButton}
                                onClick={() => {
                                    setShowModal(false);
                                    setImportText("");
                                    setError("");
                                }}
                                disabled={isImporting()}
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </Show>
        </>
    );
};