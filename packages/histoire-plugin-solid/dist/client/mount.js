import{render as p,createComponent as d}from"solid-js/web";import{defineComponent as h,h as g,ref as S,watch as w,onMounted as x,onUnmounted as M}from"@histoire/vendors/vue";import*as u from"virtual:$histoire-generated-global-setup";import*as c from"virtual:$histoire-setup";import{MountStoryWithContext as v,MountVariant as b,MountStory as C}from"./components.js";import{format as V}from"prettier/standalone";import W from"prettier/plugins/babel";import H from"prettier/plugins/estree";async function P(t){try{let e=await V(t,{parser:"babel",plugins:[W,H],printWidth:50,tabWidth:2,useTabs:!1,semi:!1,singleQuote:!0,jsxSingleQuote:!1,singleAttributePerLine:!0});return e=e.trim(),e.startsWith(";")&&(e=e.slice(1).trim()),e}catch(e){return console.warn("[histoire-plugin-solid] Prettier formatting failed:",e),t.trim()}}async function E(t){var o;const e=(o=t.file)==null?void 0:o.source;if(e)try{const l=(await e()).default;for(const i of t.variants){const n=await F(l,i.title);n&&(i.source=n)}}catch(r){console.warn("[histoire-plugin-solid] Failed to extract variant sources:",r)}}async function F(t,e){const o=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=new RegExp(`<Hst\\.Variant[^>]*title=["']${o}["'][^>]*>`,"s"),l=t.match(r);if(!l)return null;const i=l.index+l[0].length;let n=1,a=i;const s=t.slice(i),m=/<Hst\.Variant[^>]*>|<\/Hst\.Variant>/g;let f;for(;(f=m.exec(s))!==null;)if(f[0].startsWith("</")){if(n--,n===0){a=i+f.index;break}}else n++;if(n!==0)return null;const y=t.slice(i,a).trim();return P(y)}const k=h({name:"MountStory",props:{story:{type:Object,required:!0}},setup(t){console.log("[histoire-plugin-solid] MountStory setup() called!",t);const e=S();let o=null,r=null;async function l(){var n;if(console.log("[histoire-plugin-solid] MountStory mountStory() called"),r=document.createElement("div"),(n=e.value)==null||n.appendChild(r),await E(t.story),o=p(()=>{var s;const a=(s=t.story.file)==null?void 0:s.component;return a?d(v,{get story(){return t.story},get children(){return d(a,{Hst:{Story:C,Variant:b}})}}):null},r),typeof(u==null?void 0:u.setupSolid)=="function"){const a=u.setupSolid;await a({story:t.story,variant:null})}if(typeof(c==null?void 0:c.setupSolid)=="function"){const a=c.setupSolid;await a({story:t.story,variant:null})}}function i(){var n;o==null||o(),o=null,r&&((n=r.parentNode)==null||n.removeChild(r),r=null)}return w(()=>t.story.id,async()=>{i(),await l()}),x(async()=>{await l()}),M(()=>{i()}),{el:e}},render(){return g("div",{ref:"el"})}});export{k as default};
